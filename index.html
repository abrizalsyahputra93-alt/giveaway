<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kick Command Manager</title>
  <style>
    body {font-family: 'Segoe UI', sans-serif;background: #1a1a1a;color: #fff;margin: 0;padding: 20px;}
    .container {max-width: 600px;margin: auto;background: #252525;padding: 20px;border-radius: 12px;box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    h1 {text-align: center;color: #00ff88;}
    input, button {padding: 10px;margin: 8px 0;border-radius: 6px;border: none;}
    input {width: 100%;background: #333;color: #fff;}
    button {background: #00ff88;color: #000;font-weight: bold;cursor: pointer;}
    button:hover {background: #00cc70;}
    .commands {margin-top: 20px;}
    .cmd-item {background: #333;padding: 10px;margin: 8px 0;border-radius: 6px;display: flex;justify-content: space-between;align-items: center;}
    .logout {background: #ff4444;margin-top: 20px;}
    .logout:hover {background: #cc0000;}
    .debug {background:#333;padding:10px;margin:10px 0;border-radius:6px;font-family:monospace;font-size:12px;max-height:200px;overflow:auto;white-space: pre-wrap;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Kick Command Manager</h1>

    <div id="loginSection">
      <p>Login ke Kick untuk mulai (OAuth + PKCE).</p>
      <button onclick="startLogin()">Login with Kick</button>
      <div class="debug" id="debug"></div>
    </div>

    <div id="appSection" style="display:none;">
      <p>Selamat datang! Token: <span id="tokenPreview"></span></p>
      <button class="logout" onclick="logout()">Logout</button>
      <h3>Tambah Command</h3>
      <input id="cmdInput" placeholder="!hello" />
      <input id="msgInput" placeholder="Halo dunia!" />
      <button onclick="addCommand()">Tambah</button>
      <div class="commands">
        <h3>Custom Commands</h3>
        <div id="commandList"></div>
      </div>
    </div>
  </div>

  <script>
    // CONFIG SESUAI DOCS KICK (PKCE ONLY, NO SECRET)
    const CLIENT_ID = '01K9SEDGKEAB4KH7WAJ8Q2XGVD';
    const REDIRECT_URI = 'https://giveaway-xi-five.vercel.app/'; // EXACT MATCH DENGAN CONSOLE
    const AUTH_URL = 'https://id.kick.com/oauth/authorize';
    const TOKEN_URL = 'https://id.kick.com/oauth/token';

    const debugEl = document.getElementById('debug');

    function log(msg) {
      debugEl.textContent += msg + '\n';
      console.log(msg);
    }

    // PKCE: Generate verifier 43 char EXACT (sesuai OAuth spec)
    function generateCodeVerifier() {
      let verifier = '';
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      for (let i = 0; i < 43; i++) {
        verifier += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return verifier;
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await window.crypto.subtle.digest('SHA-256', data);
      const hashed = new Uint8Array(digest);
      let challenge = btoa(String.fromCharCode(...hashed))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      return challenge;
    }

    // START LOGIN
    async function startLogin() {
      debugEl.textContent = '';
      const verifier = generateCodeVerifier();
      log('Verifier (43 char): ' + verifier + ' (length: ' + verifier.length + ')');
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem('pkce_verifier', verifier);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: 'chat:write user:read',
        code_challenge: challenge,
        code_challenge_method: 'S256',
        state: 'kick_state_' + Date.now()
      });

      const url = `${AUTH_URL}?${params.toString()}`;
      log('Authorize URL: ' + url);
      window.location.href = url;
    }

    // HANDLE CALLBACK
    async function handleCallback() {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const error = urlParams.get('error');
      const state = urlParams.get('state');

      if (error) {
        log('Authorize Error: ' + error + ' - ' + urlParams.get('error_description'));
        alert('Authorize Error: ' + error);
        return;
      }
      if (!code || !state || !state.startsWith('kick_state_')) {
        log('No code or invalid state');
        return;
      }

      const verifier = localStorage.getItem('pkce_verifier');
      if (!verifier || verifier.length !== 43) {
        log('PKCE Verifier invalid: ' + (verifier ? verifier.length : 'missing'));
        alert('PKCE Error - Login ulang');
        return;
      }

      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: CLIENT_ID,
        code: code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      });

      log('Token POST to: ' + TOKEN_URL);
      log('Token Body: ' + body.toString());

      try {
        const response = await fetch(TOKEN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString()
        });

        const text = await response.text();
        log('Token Status: ' + response.status);
        log('Token Response: ' + text);

        if (response.ok) {
          const data = JSON.parse(text);
          if (data.access_token) {
            localStorage.setItem('accessToken', data.access_token);
            localStorage.removeItem('pkce_verifier');
            history.replaceState(null, null, '/');
            showApp(data.access_token);
          } else {
            alert('No access_token: ' + JSON.stringify(data));
          }
        } else if (response.status === 400) {
          // Common 400 errors from docs
          if (text.includes('invalid_grant')) alert('Code expired/invalid - Login ulang cepat!');
          else if (text.includes('invalid_redirect_uri')) alert('Redirect URI mismatch - Cek console Kick!');
          else alert('400 Bad Request: ' + text + '\nCoba login ulang atau report ke Kick Discord.');
        } else {
          alert('HTTP ' + response.status + ': ' + text);
        }
      } catch (err) {
        log('Fetch Error: ' + err.message);
        alert('Network Error: ' + err.message);
      }
    }

    // SHOW APP
    function showApp(token) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('tokenPreview').textContent = token.substring(0, 20) + '...';
      loadCommands();
    }

    // COMMANDS
    function loadCommands() {
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      const list = document.getElementById('commandList');
      list.innerHTML = '';
      for (let [cmd, msg] of Object.entries(commands)) {
        const div = document.createElement('div');
        div.className = 'cmd-item';
        div.innerHTML = `<strong>${cmd}</strong>: ${msg} <button onclick="deleteCmd('${cmd}')" style="background:#ff4444;font-size:12px;padding:4px 8px;">Hapus</button>`;
        list.appendChild(div);
      }
    }

    function addCommand() {
      const cmd = document.getElementById('cmdInput').value.trim().toLowerCase();
      const msg = document.getElementById('msgInput').value.trim();
      if (!cmd || !msg) return alert('Isi command & pesan!');
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      commands[cmd] = msg;
      localStorage.setItem('cmds', JSON.stringify(commands));
      document.getElementById('cmdInput').value = '';
      document.getElementById('msgInput').value = '';
      loadCommands();
    }

    function deleteCmd(cmd) {
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      delete commands[cmd];
      localStorage.setItem('cmds', JSON.stringify(commands));
      loadCommands();
    }

    function logout() {
      localStorage.clear();
      debugEl.textContent = '';
      location.reload();
    }

    // INIT
    window.onload = () => {
      const token = localStorage.getItem('accessToken');
      if (token) {
        showApp(token);
      } else {
        handleCallback();
      }
    };
  </script>
</body>
</html>
