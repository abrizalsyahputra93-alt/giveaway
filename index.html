<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kick Command Manager</title>
  <style>
    body {font-family: 'Segoe UI', sans-serif;background: #1a1a1a;color: #fff;margin: 0;padding: 20px;}
    .container {max-width: 600px;margin: auto;background: #252525;padding: 20px;border-radius: 12px;box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    h1 {text-align: center;color: #00ff88;}
    input, button {padding: 10px;margin: 8px 0;border-radius: 6px;border: none;}
    input {width: 100%;background: #333;color: #fff;}
    button {background: #00ff88;color: #000;font-weight: bold;cursor: pointer;}
    button:hover {background: #00cc70;}
    .commands {margin-top: 20px;}
    .cmd-item {background: #333;padding: 10px;margin: 8px 0;border-radius: 6px;display: flex;justify-content: space-between;align-items: center;}
    .logout {background: #ff4444;margin-top: 20px;}
    .logout:hover {background: #cc0000;}
    .debug {background:#333;padding:10px;margin:10px 0;border-radius:6px;font-family:monospace;font-size:12px;max-height:200px;overflow:auto;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Kick Command Manager</h1>

    <div id="loginSection">
      <p>Login ke Kick untuk mulai.</p>
      <button onclick="startLogin()">Login with Kick</button>
      <div class="debug" id="debug"></div>
    </div>

    <div id="appSection" style="display:none;">
      <p>Selamat datang! <span id="tokenPreview"></span></p>
      <button class="logout" onclick="logout()">Logout</button>
      <h3>Tambah Command</h3>
      <input id="cmdInput" placeholder="!hello" />
      <input id="msgInput" placeholder="Halo dunia!" />
      <button onclick="addCommand()">Tambah</button>
      <div class="commands">
        <h3>Custom Commands</h3>
        <div id="commandList"></div>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG HARDCODE (PASTI COCOK) ===
    const CLIENT_ID = '01K9SEDGKEAB4KH7WAJ8Q2XGVD';
    const REDIRECT_URI = 'https://giveaway-xi-five.vercel.app/'; // EXACT MATCH!
    const AUTH_URL = 'https://id.kick.com/oauth/authorize';
    const TOKEN_URL = 'https://id.kick.com/oauth/token';

    const debug = document.getElementById('debug');

    function log(msg) {
      debug.innerHTML += msg + '<br>';
      console.log(msg);
    }

    // PKCE: 43 karakter
    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      let verifier = btoa(String.fromCharCode(...array))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
      while (verifier.length < 43) verifier += 'A';
      return verifier.substring(0, 43);
    }

    async function generateCodeChallenge(verifier) {
      const data = new TextEncoder().encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // === LOGIN ===
    async function startLogin() {
      debug.innerHTML = '';
      const verifier = generateCodeVerifier();
      log('Verifier (43 char): ' + verifier);
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem('pkce_verifier', verifier);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: 'chat:write user:read',
        code_challenge: challenge,
        code_challenge_method: 'S256',
        state: 'kick_' + Date.now()
      });

      const url = `${AUTH_URL}?${params.toString()}`;
      log('Login URL: ' + url);
      location.href = url;
    }

    // === CALLBACK ===
    async function handleCallback() {
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      const error = params.get('error');

      if (error) {
        log('Kick Error: ' + error);
        log('Desc: ' + params.get('error_description'));
        alert('Error: ' + error);
        return;
      }
      if (!code) return;

      const verifier = localStorage.getItem('pkce_verifier');
      if (!verifier || verifier.length !== 43) {
        log('PKCE Error: Verifier = ' + verifier);
        alert('PKCE Error');
        return;
      }

      const body = new URLSearchParams({
        grant_type: 'authorization_code',
        client_id: CLIENT_ID,
        code: code,
        redirect_uri: REDIRECT_URI,
        code_verifier: verifier
      });

      log('POST to: ' + TOKEN_URL);
      log('Body: ' + body.toString());

      try {
        const response = await fetch(TOKEN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body
        });

        const text = await response.text();
        log('Status: ' + response.status);
        log('Response: ' + text);

        if (response.ok) {
          const data = JSON.parse(text);
          localStorage.setItem('accessToken', data.access_token);
          localStorage.removeItem('pkce_verifier');
          history.replaceState(null, null, '/');
          showApp(data.access_token);
        } else {
          alert('HTTP ' + response.status + '\n' + text);
        }
      } catch (err) {
        log('Fetch error: ' + err.message);
      }
    }

    function showApp(token) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('tokenPreview').textContent = token.substring(0, 15) + '...';
      loadCommands();
    }

    function loadCommands() {
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      const list = document.getElementById('commandList');
      list.innerHTML = '';
      Object.entries(commands).forEach(([cmd, msg]) => {
        const div = document.createElement('div');
        div.className = 'cmd-item';
        div.innerHTML = `<strong>${cmd}</strong>: ${msg} <button onclick="deleteCmd('${cmd}')">Hapus</button>`;
        list.appendChild(div);
      });
    }

    function addCommand() {
      const cmd = document.getElementById('cmdInput').value.trim().toLowerCase();
      const msg = document.getElementById('msgInput').value.trim();
      if (!cmd || !msg) return alert('Isi semua!');
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      commands[cmd] = msg;
      localStorage.setItem('cmds', JSON.stringify(commands));
      document.getElementById('cmdInput').value = '';
      document.getElementById('msgInput').value = '';
      loadCommands();
    }

    function deleteCmd(cmd) {
      const commands = JSON.parse(localStorage.getItem('cmds') || '{}');
      delete commands[cmd];
      localStorage.setItem('cmds', JSON.stringify(commands));
      loadCommands();
    }

    function logout() {
      localStorage.clear();
      location.reload();
    }

    // INIT
    window.onload = () => {
      const token = localStorage.getItem('accessToken');
      if (token) showApp(token);
      handleCallback();
    };
  </script>
</body>
</html>
