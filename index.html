<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kick Custom Command Manager</title>
  <style>
    body {font-family: 'Segoe UI', sans-serif;background: #1a1a1a;color: #fff;margin: 0;padding: 20px;}
    .container {max-width: 600px;margin: auto;background: #252525;padding: 20px;border-radius: 12px;box-shadow: 0 4px 12px rgba(0,0,0,0.3);}
    h1 {text-align: center;color: #00ff88;}
    input, button {padding: 10px;margin: 8px 0;border-radius: 6px;border: none;}
    input {width: 100%;background: #333;color: #fff;}
    button {background: #00ff88;color: #000;font-weight: bold;cursor: pointer;}
    button:hover {background: #00cc70;}
    .commands {margin-top: 20px;}
    .cmd-item {background: #333;padding: 10px;margin: 8px 0;border-radius: 6px;display: flex;justify-content: space-between;align-items: center;}
    .logout {background: #ff4444;margin-top: 20px;}
    .logout:hover {background: #cc0000;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Kick Command Manager</h1>

    <div id="loginSection">
      <p>Login ke Kick untuk mulai mengatur command.</p>
      <button onclick="startLogin()">Login with Kick</button>
    </div>

    <div id="appSection" style="display:none;">
      <p>Selamat datang! <span id="tokenPreview"></span></p>
      <button class="logout" onclick="logout()">Logout</button>

      <h3>Tambah Command</h3>
      <input id="cmdInput" placeholder="!hello" />
      <input id="msgInput" placeholder="Halo dunia!" />
      <button onclick="addCommand()">Tambah</button>

      <div class="commands">
        <h3>Custom Commands</h3>
        <div id="commandList"></div>
      </div>
    </div>
  </div>

  <script>
    // PERBAIKAN: Client ID & Redirect URI
    const CLIENT_ID = '01K9SEDGKEAB4KH7WAJ8Q2XGVD';
    const REDIRECT_URI = 'https://giveaway-xi-five.vercel.app/';
    const AUTH_URL = 'https://id.kick.com/oauth/authorize';
    const TOKEN_URL = 'https://id.kick.com/oauth/token';

    // PKCE Helper
    function generateCodeVerifier() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return btoa(String.fromCharCode(...array))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function generateCodeChallenge(verifier) {
      const encoder = new TextEncoder();
      const data = encoder.encode(verifier);
      const digest = await crypto.subtle.digest('SHA-256', data);
      return btoa(String.fromCharCode(...new Uint8Array(digest)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    // Login
    async function startLogin() {
      const verifier = generateCodeVerifier();
      const challenge = await generateCodeChallenge(verifier);
      localStorage.setItem('codeVerifier', verifier);

      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: 'chat:write user:read',
        code_challenge: challenge,
        code_challenge_method: 'S256',
        state: 'kickcmd_' + Date.now()
      });

      location.href = `${AUTH_URL}?${params}`;
    }

    // Handle callback
    async function handleCallback() {
      const urlParams = new URLSearchParams(location.search);
      const code = urlParams.get('code');
      if (!code) return;

      const verifier = localStorage.getItem('codeVerifier');
      if (!verifier) return alert('PKCE verifier hilang. Coba login ulang.');

      try {
        const response = await fetch(TOKEN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            client_id: CLIENT_ID,
            code: code,
            redirect_uri: REDIRECT_URI,
            code_verifier: verifier
          })
        });

        const data = await response.json();
        if (data.access_token) {
          localStorage.setItem('accessToken', data.access_token);
          localStorage.removeItem('codeVerifier');
          history.replaceState(null, null, '/');
          showApp(data.access_token);
        } else {
          alert('Gagal login: ' + (data.error || 'Unknown'));
        }
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    function showApp(token) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('appSection').style.display = 'block';
      document.getElementById('tokenPreview').textContent = token.substring(0, 15) + '...';
      loadCommands();
    }

    function loadCommands() {
      const commands = JSON.parse(localStorage.getItem('customCommands') || '{}');
      const list = document.getElementById('commandList');
      list.innerHTML = '';
      Object.entries(commands).forEach(([cmd, msg]) => {
        const div = document.createElement('div');
        div.className = 'cmd-item';
        div.innerHTML = `<strong>${cmd}</strong>: ${msg} <button onclick="deleteCommand('${cmd}')" style="background:#ff4444;font-size:12px;padding:4px 8px;">Hapus</button>`;
        list.appendChild(div);
      });
    }

    function addCommand() {
      const cmd = document.getElementById('cmdInput').value.trim();
      const msg = document.getElementById('msgInput').value.trim();
      if (!cmd || !msg) return alert('Isi command dan pesan!');

      const commands = JSON.parse(localStorage.getItem('customCommands') || '{}');
      commands[cmd.toLowerCase()] = msg;
      localStorage.setItem('customCommands', JSON.stringify(commands));

      document.getElementById('cmdInput').value = '';
      document.getElementById('msgInput').value = '';
      loadCommands();
    }

    function deleteCommand(cmd) {
      const commands = JSON.parse(localStorage.getItem('customCommands') || '{}');
      delete commands[cmd];
      localStorage.setItem('customCommands', JSON.stringify(commands));
      loadCommands();
    }

    function logout() {
      localStorage.removeItem('accessToken');
      location.reload();
    }

    window.onload = () => {
      const token = localStorage.getItem('accessToken');
      if (token) showApp(token);
      handleCallback();
    };
  </script>
</body>
</html>
