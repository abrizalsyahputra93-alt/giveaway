<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KICK GIVEAWAY MALAM INI</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <style>
        body{margin:0;background:#000;color:#0f0;font-family:Arial;text-align:center;padding:20px;background:radial-gradient(#1a0033,#000)}
        .box{max-width:680px;margin:20px auto;background:#111;padding:70px;border-radius:40px;border:7px solid #00ff9d;box-shadow:0 0 200px #00ff9d;position:relative;overflow:hidden}
        h1{font-size:6.5rem;background:linear-gradient(#00ff9d,#7c3aed);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin:0}
        button{padding:30px 100px;margin:40px;font-size:42px;border:none;border-radius:70px;cursor:pointer;font-weight:bold}
        .login{background:#00ff9d;color:#000;animation:p 2s infinite}@keyframes p{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .start{background:#7c3aed;color:#fff}
        .log{background:#000;color:#0f0;padding:40px;height:500px;overflow-y:auto;border:6px solid #00ff9d;border-radius:30px;font-family:consolas;margin:40px 0}
        .wl{background:#001;padding:35px;border:6px dashed #0f0;border-radius:30px;margin:40px 0}
        input{width:90%;padding:25px;border-radius:25px;border:none;margin:20px;font-size:24px;text-align:center;background:#111;color:#0f0}
        .hidden{display:none}
        .win{font-size:140px;background:linear-gradient(gold,orange,red,purple,cyan);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:w 1.5s infinite}@keyframes w{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
        .glow{pointer-events:none;position:absolute;inset:0;background:radial-gradient(circle at 50% 50%,rgba(0,255,157,0.4),transparent);animation:g 20s infinite}@keyframes g{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
<div class="box"><div class="glow"></div>
    <h1>KICK GIVEAWAY<br>MALAM INI</h1>

    <div id="loginScreen">
        <button class="login" onclick="login()">LOGIN WITH KICK</button>
    </div>

    <div id="dashboard" class="hidden">
        <h2>Selamat datang bro!</h2>
        <h3>Channel: <strong id="channel">loading...</strong></h3>
        <button class="start" onclick="startBot()">START GIVEAWAY BOT</button>
        
        <h3>Whitelist User</h3>
        <input id="nu" placeholder="Masukkan username Kick"><button onclick="add()">+ Tambah</button>
        <div id="wl" class="wl">Belum ada whitelist</div>
        
        <h3>Peserta: <strong id="total">0</strong></h3>
        <button class="start" onclick="roll()">ROLL SEKARANG!!</button>
        
        <h2 id="win" class="win hidden">SELAMAT <span id="wn">?</span> !!!</h2>
        
        <h3>Live Chat Log</h3>
        <div id="log" class="log">Bot siap menunggu perintah...</div>
    </div>
</div>

<script>
// CLIENT ID KAMU (SUDAH BENAR)
const CLIENT_ID = "01K9RZ3A2G1PTZ8FSA65ZH3VXZ";

let token = "", chatroomId = "", participants = [], whitelist = JSON.parse(localStorage.getItem("kickgiveaway_id") || "[]");

async function sha256(str) {
    const data = new TextEncoder().encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(hash))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

function login() {
    const verifier = btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(64)))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
    const state = Date.now().toString(36) + Math.random().toString(36);
    
    sha256(verifier).then(challenge => {
        localStorage.setItem("cv", verifier);
        localStorage.setItem("st", state);
        
        location.href = `https://kick.com/oauth/authorize?response_type=code&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(location.origin+"/")}&scope=user:read channel:read chat:read chat:write&state=${state}&code_challenge=${challenge}&code_challenge_method=S256`;
    });
}

// TANGKAP CODE & LANGSUNG TUKAR TOKEN + DAPATKAN USER INFO
if (location.search.includes("code=")) {
    const url = new URL(location.href);
    const code = url.searchParams.get("code");
    const state = url.searchParams.get("state");
    
    if (code && state === localStorage.getItem("st")) {
        (async () => {
            const verifier = localStorage.getItem("cv");
            
            const tokenRes = await fetch("https://kick.com/oauth/token", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    grant_type: "authorization_code",
                    client_id: CLIENT_ID,
                    code: code,
                    code_verifier: verifier,
                    redirect_uri: location.origin + "/"
                })
            });
            
            const tokenData = await tokenRes.json();
            token = tokenData.access_token;

            // ENDPOINT YANG 100% JALAN HARI INI (11 NOV 2025)
            const userRes = await fetch("https://api.kick.com/api/v2/oauth/userinfo", {
                headers: { "Authorization": "Bearer " + token }
            });
            const userData = await userRes.json();

            document.getElementById("channel").textContent = userData.preferred_username || userData.username;
            chatroomId = userData.chatroom_id;

            document.getElementById("loginScreen").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");
            
            log(`<b style="color:#00ff9d;font-size:2rem">LOGIN SUKSES! SELAMAT DATANG @${userData.preferred_username}!</b>`);
            log(`<b style="color:gold">Connection tab di Kick sudah muncul bro!</b>`);
            
            history.replaceState({}, "", "/");
        })();
    }
}

function log(t) {
    const logEl = document.getElementById("log");
    logEl.innerHTML += t + "<br>";
    logEl.scrollTop = logEl.scrollHeight;
}

function startBot() {
    const ws = new WebSocket("wss://ws.kick.com/chatroom/" + chatroomId);
    ws.onmessage = msg => {
        try {
            const data = JSON.parse(msg.data);
            if (data.event === "message") {
                const username = data.data.sender.username;
                const content = data.data.message.content;
                log(`[${username}] ${content}`);
                
                if (whitelist.includes(username) && content.toLowerCase().includes("!join")) {
                    if (!participants.includes(username)) {
                        participants.push(username);
                        log(`<b style="color:#0f0;font-size:2rem">JOINED → ${username}</b>`);
                        document.getElementById("total").textContent = participants.length;
                    }
                }
            }
        } catch(e) {}
    };
    log("<b style='color:yellow;font-size:3rem'>GIVEAWAY DIMULAI! KETIK !join SEKARANG BRO!</b>");
}

function add() {
    const name = document.getElementById("nu").value.trim();
    if (name && !whitelist.includes(name)) {
        whitelist.push(name);
        localStorage.setItem("kickgiveaway_id", JSON.stringify(whitelist));
        document.getElementById("nu").value = "";
        updateWhitelist();
    }
}

function updateWhitelist() {
    document.getElementById("wl").innerHTML = whitelist.length === 0 ? "Belum ada whitelist" : 
        whitelist.map(u => `<div style="background:#002;padding:20px;margin:10px;border-radius:20px">${u} <button onclick="this.parentNode.remove();whitelist=whitelist.filter(x=>x!=='${u}');localStorage.setItem('kickgiveaway_id',JSON.stringify(whitelist));updateWhitelist()">Hapus</button></div>`).join('');
}

function roll() {
    if (participants.length === 0) return alert("Belum ada peserta bro!");
    const winner = participants[Math.floor(Math.random() * participants.length)];
    document.getElementById("wn").textContent = winner;
    document.getElementById("win").classList.remove("hidden");
    confetti({particleCount: 1200, spread: 100, origin: { y: 0.6 }});
    
    fetch(`https://api.kick.com/api/v2/channels/${chatroomId}/messages`, {
        method: "POST",
        headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" },
        body: JSON.stringify({ content: `@everyone GILA NIH BRO @${winner} MENANG GIVEAWAY MALAM INI!!! CONGRATS GUE KASIH SALUT BESAR BUAT KAMU!!!` })
    });
    
    log(`<b style="color:gold;font-size:5rem">PEMENANG: @${winner} — SUDAH DIANNOUNCED!</b>`);
}

updateWhitelist();
</script>
</body>
</html>
